{"version":3,"file":"apizclient.esm.js","sources":["../src/index.ts"],"sourcesContent":["/* global DEBUG */\n// tslint:disable-next-line\nimport { MIMEType, ajax, AjaxOptions } from 'tinyjx';\n// tslint:disable-next-line\nimport { APIzClient, HTTPMethodLowerCase, ClientRequestOptions, APIzClientRequest, HTTPMethodUpperCase } from 'apiz-ng';\n\nexport type APIzClientType = keyof MIMEType;\n\nexport type APIzClientMeta = any;\n\nexport type APIzClientInstance = APIzClient<AjaxOptions, APIzClientType, any, HTTPMethodLowerCase>;\n\nexport { AjaxOptions as APIzRawRequestOptions };\n\nexport interface APIzClientConstructorOptions {\n\tbeforeSend?: (xhr: XMLHttpRequest) => void | boolean,\n\tafterResponse?: (resData: any, status: string, xhr: XMLHttpRequest, url: string, reqData: any) => void,\n\terror?: (errType: string, err: Error, data: any, xhr: XMLHttpRequest) => void,\n\tretry?: number\n}\n\ninterface APIzClientConstructorOptionsWithMethod extends APIzClientConstructorOptions {\n\tmethod: HTTPMethodUpperCase;\n}\n\ntype Callable = (...args: Array<any>) => any;\n\nconst isFn = (f: any): f is Callable => typeof f === 'function';\n\nfunction isPromise<T = any>(p: any): p is Promise<T> {\n\treturn !!(p && typeof p.then === 'function');\n}\n\nasync function pRetry<Result = any>(\n\tthis: any,\n\tfn: (...args: any[]) => any,\n\t{\n\t\tretry,\n\t\tbeforeRetry\n\t}: {\n\t\tretry: number;\n\t\tbeforeRetry?: (retryCount: number, e: Error) => any;\n\t},\n\talreadyTried: number = 1\n): Promise<Result> {\n\tlet rst: Result | Promise<Result> | null = null;\n\tif (retry < 0 || (retry > Number.MAX_SAFE_INTEGER && retry !== Infinity)) {\n\t\tthrow new Error('retry must be between 0 to Number.MAX_SAFE_INTEGER or be Infinity');\n\t}\n\n\ttry {\n\t\trst = fn.call(this);\n\t\tif (isPromise<Result>(rst)) {\n\t\t\trst = await rst;\n\t\t}\n\t} catch (e) {\n\t\tif (beforeRetry) {\n\t\t\tbeforeRetry(alreadyTried, e);\n\t\t}\n\t\tif (retry) {\n\t\t\treturn pRetry<Result>(\n\t\t\t\tfn,\n\t\t\t\t{\n\t\t\t\t\t// tslint:disable-next-line\n\t\t\t\t\tretry: --retry,\n\t\t\t\t\tbeforeRetry\n\t\t\t\t},\n\t\t\t\t// tslint:disable-next-line\n\t\t\t\t++alreadyTried\n\t\t\t);\n\t\t} else {\n\t\t\tthrow e;\n\t\t}\n\t}\n\treturn rst!;\n}\n\n\nfunction createRequest({\n\t\tmethod,\n\t\tbeforeSend,\n\t\tafterResponse,\n\t\terror,\n\t\tretry = 0\n\t}: APIzClientConstructorOptionsWithMethod\n): APIzClientRequest<AjaxOptions, APIzClientType, APIzClientMeta> {\n\treturn function request({\n\t\turl,\n\t\toptions,\n\t\tbody,\n\t\theaders,\n\t\ttype,\n\t\thandleError = true\n\t}: ClientRequestOptions<AjaxOptions, APIzClientType, APIzClientMeta>): Promise<any> {\n\t\tlet $options: AjaxOptions | undefined, count = 0;\n\t\tif (options) {\n\t\t\t$options = {\n\t\t\t\t...options,\n\t\t\t\turl,\n\t\t\t\tmethod\n\t\t\t};\n\t\t} else {\n\t\t\t$options = {\n\t\t\t\turl,\n\t\t\t\tmethod,\n\t\t\t\tprocessData: false,\n\t\t\t\tdata: body,\n\t\t\t\tcontentType: type,\n\t\t\t\theaders\n\t\t\t};\n\t\t}\n\t\treturn pRetry(() => {\n\t\t\t// tslint:disable-next-line\n\t\t\treturn new Promise((rs, rj) => {\n\t\t\t\tajax({\n\t\t\t\t\t...$options,\n\t\t\t\t\tbeforeSend(xhr: XMLHttpRequest): any {\n\t\t\t\t\t\tif (!count && isFn(beforeSend)) {\n\t\t\t\t\t\t\treturn beforeSend(xhr);\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tsuccess(data: any, xhr: XMLHttpRequest): void {\n\t\t\t\t\t\tisFn(afterResponse) && count === retry && afterResponse(data, 'success', xhr, url, body);\n\t\t\t\t\t\trs({\n\t\t\t\t\t\t\tdata,\n\t\t\t\t\t\t\txhr\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\trecoverableError(err: Error, data: any, xhr: XMLHttpRequest): void {\n\t\t\t\t\t\tisFn(afterResponse) && count === retry && afterResponse(data, 'error', xhr, url, body);\n\t\t\t\t\t\tisFn(error) && count === retry && handleError && error('recoverableError', err, data, xhr);\n\t\t\t\t\t\trj({\n\t\t\t\t\t\t\terr,\n\t\t\t\t\t\t\tdata\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\tunrecoverableError(err: Error, xhr: XMLHttpRequest): void {\n\t\t\t\t\t\tisFn(error) && count === retry && handleError && error('unrecoverableError', err, undefined, xhr);\n\t\t\t\t\t\trj({\n\t\t\t\t\t\t\terr,\n\t\t\t\t\t\t\tdata: undefined\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}, {\n\t\t\tretry,\n\t\t\tbeforeRetry(): void {\n\t\t\t\t++count;\n\t\t\t}\n\t\t});\n\t};\n}\n\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts: APIzClientConstructorOptions = {}): APIzClientInstance {\n\treturn (['get', 'head', 'post', 'put', 'patch', 'delete', 'options'] as Array<HTTPMethodLowerCase>)\n\t\t.reduce(\n\t\t\t(prev: APIzClientInstance, cur: HTTPMethodLowerCase) => (prev[cur] = createRequest({\n\t\t\t\t...opts,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase\n\t\t\t}), prev),\n\t\t\t{} as APIzClientInstance\n\t\t);\n}\n"],"names":["isFn","f","isPromise","p","then","pRetry","fn","retry","beforeRetry","alreadyTried","rst","Number","MAX_SAFE_INTEGER","Infinity","Error","call","e","createRequest","method","beforeSend","afterResponse","error","request","url","options","body","headers","type","handleError","$options","count","processData","data","contentType","Promise","rs","rj","ajax","xhr","success","recoverableError","err","unrecoverableError","undefined","opts","reduce","prev","cur","toUpperCase"],"mappings":"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"}