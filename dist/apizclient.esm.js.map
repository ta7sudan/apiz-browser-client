{"version":3,"file":"apizclient.esm.js","sources":["../src/index.ts"],"sourcesContent":["/* global DEBUG */\n// tslint:disable-next-line\nimport { MIMEType, ajax, AsyncOptions } from 'tinyjx';\n// tslint:disable-next-line\nimport { APIzClient, HTTPMethodLowerCase, ClientRequestOptions, HTTPMethodUpperCase } from \"apiz-ng\";\n\nconst retryMap: {\n\t[k: number]: number;\n\t// tslint:disable-next-line\n} = {}, isFn = (f: any): f is Function => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts: RequestOptions): Promise<any> {\n\t// tslint:disable-next-line\n\tlet { url, method, type, data, beforeSend, afterResponse, complete, retry = 0, options = {}, id = ++reqId } = opts, reqData: any;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\treqData = options.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\t// $防止遮蔽\n\t\t\tsuccess($data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse($data, 'success', xhr, url, reqData);\n\t\t\t\trs({\n\t\t\t\t\t$data,\n\t\t\t\t\tnext() {\n\t\t\t\t\t\tisFn(complete) && complete($data, xhr, url, reqData);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\t// $防止遮蔽\n\t\t\terror(err, $data, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse($data, 'error', xhr, url, reqData);\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(complete) && complete(undefined, xhr, url, reqData);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\nexport interface APIzClientOptions {\n\tbeforeSend?(xhr: XMLHttpRequest): void | boolean,\n\tafterResponse?(resData: any, status: string, xhr: XMLHttpRequest, url: string, reqData: any): void,\n\tcomplete?(resData: any, xhr: XMLHttpRequest, url: string, reqData: any): void,\n\tretry?: number\n}\n\ninterface RequestOptions extends APIzClientOptions {\n\tid?: number;\n\turl: string;\n\ttype?: APIzClientType;\n\toptions?: AsyncOptions;\n\tmethod: HTTPMethodUpperCase;\n\tdata?: any;\n}\n\nexport type APIzClientType = keyof MIMEType;\n\nexport type APIzClientMeta = any;\n\nexport type APIzClientInstance = APIzClient<APIzClientType, APIzClientMeta, AsyncOptions, HTTPMethodLowerCase>;\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts: APIzClientOptions = {}): APIzClientInstance {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur as HTTPMethodLowerCase] = ({ name, meta, url, options }: ClientRequestOptions<APIzClientType, APIzClientMeta, AsyncOptions>) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase,\n\t\t\t\toptions\n\t\t\t}), prev), {} as APIzClient<APIzClientType, APIzClientMeta, AsyncOptions, HTTPMethodLowerCase>),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur as HTTPMethodLowerCase] = ({ name, meta, url, body, options, type }: ClientRequestOptions<APIzClientType, APIzClientMeta, AsyncOptions>) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase,\n\t\t\t\tdata: body\n\t\t\t}), prev), {} as APIzClient<APIzClientType, APIzClientMeta, AsyncOptions, HTTPMethodLowerCase>)\n\t};\n}\n"],"names":[],"mappings":"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"}