{"version":3,"file":"apizclient.min.js","sources":["apizclient.js"],"sourcesContent":["/* global DEBUG */\nimport { ajax } from 'tinyjx';\n\nconst retryMap = {};\nlet reqId = Date.now();\n\nfunction request(opts) {\n\tlet { url, method, type, data, beforeSend, afterResponse, retry = 0, options = {}, id = ++reqId } = opts;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\toptions.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\tsuccess(data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\ttypeof afterResponse === 'function' && afterResponse(data, xhr, url, options.data);\n\t\t\t\trs(data);\n\t\t\t},\n\t\t\terror(err, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\ttypeof afterResponse === 'function' && afterResponse(null, xhr, url, options.data);\n\t\t\t\t\trj(err);\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts = {}) {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, options }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\toptions\n\t\t\t}), prev), {}),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, body, options, type }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\tdata: body\n\t\t\t}), prev), {})\n\t};\n}\n"],"names":["request","opts","url","method","type","data","beforeSend","afterResponse","retry","options","id","reqId","retryMap","contentType","Promise","rs","rj","ajax","success","xhr","error","err","reduce","prev","cur","name","meta","toUpperCase","body","Date","now"],"mappings":"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"}