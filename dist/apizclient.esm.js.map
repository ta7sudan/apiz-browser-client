{"version":3,"file":"apizclient.esm.js","sources":["../src/index.js"],"sourcesContent":["/* global DEBUG */\nimport { ajax } from 'tinyjx';\n\nconst retryMap = {}, isFn = f => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts) {\n\tlet { url, method, type, data, beforeSend, afterResponse, onError, retry = 0, options = {}, id = ++reqId } = opts;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\toptions.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\tsuccess(data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse(data, xhr, url, options.data);\n\t\t\t\trs(data);\n\t\t\t},\n\t\t\terror(err, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse(null, xhr, url, options.data);\n\t\t\t\t\t// 受限于Promise, 没办法知道最后一个Promise什么时候结束,\n\t\t\t\t\t// 只能通过传入一个next, 由用户自己决定要不要触发全局异常处理,\n\t\t\t\t\t// 但是这增加了使用者的心智负担, 如果不记得调用next, 则全局异常处理\n\t\t\t\t\t// 不会被调用, 理想情况应当是不记得自行处理异常则默认fallback到全局\n\t\t\t\t\t// 异常, 但是没办法做到, 只能以这样一种蹩脚的形式处理了, 有好过没有\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(onError) && onError(err, xhr, url, options.data);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\n/**\n * { beforeSend, afterResponse, onError, retry }\n */\nexport default function (opts = {}) {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, options }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\toptions\n\t\t\t}), prev), {}),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, body, options, type }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\tdata: body\n\t\t\t}), prev), {})\n\t};\n}\n"],"names":["retryMap","isFn","f","reqId","Date","now","request","opts","url","method","type","data","beforeSend","afterResponse","onError","retry","options","id","contentType","Promise","rs","rj","ajax","success","xhr","error","err","next","reduce","prev","cur","name","meta","toUpperCase","body"],"mappings":"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"}