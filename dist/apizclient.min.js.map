{"version":3,"file":"apizclient.min.js","sources":["apizclient.js"],"sourcesContent":["/* global DEBUG */\nimport { ajax } from 'tinyjx';\n\nconst retryMap = {}, isFn = f => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts) {\n\tlet { url, method, type, data, beforeSend, afterResponse, complete, retry = 0, options = {}, id = ++reqId } = opts, reqData;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\treqData = options.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\tsuccess(data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse(data, 'success', xhr, url, reqData);\n\t\t\t\trs({\n\t\t\t\t\tdata,\n\t\t\t\t\tnext() {\n\t\t\t\t\t\tisFn(complete) && complete(data, xhr, url, reqData);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\terror(err, data, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse(data, 'error', xhr, url, reqData);\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(complete) && complete(undefined, xhr, url, reqData);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts = {}) {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, options }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\toptions\n\t\t\t}), prev), {}),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, body, options, type }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\tdata: body\n\t\t\t}), prev), {})\n\t};\n}\n"],"names":["request","opts","reqData","url","method","type","data","beforeSend","afterResponse","complete","retry","options","id","reqId","retryMap","contentType","Promise","rs","rj","ajax","success","xhr","isFn","next","error","err","reduce","prev","cur","name","meta","toUpperCase","body","f","Date","now"],"mappings":"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"}