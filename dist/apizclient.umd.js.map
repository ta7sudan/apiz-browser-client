{"version":3,"file":"apizclient.umd.js","sources":["../src/index.ts"],"sourcesContent":["/* global DEBUG */\n// tslint:disable-next-line\nimport { MIMEType, ajax, AsyncOptions } from 'tinyjx';\n// tslint:disable-next-line\nimport { APIzClient, HTTPMethodLowerCase, ClientRequestOptions, HTTPMethodUpperCase } from \"apiz-ng\";\n\nconst retryMap: {\n\t[k: number]: number;\n\t// tslint:disable-next-line\n} = {}, isFn = (f: any): f is Function => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts: RequestOptions): Promise<any> {\n\t// tslint:disable-next-line\n\tlet { url, method, type, data, beforeSend, afterResponse, complete, retry = 0, options = {}, id = ++reqId } = opts, reqData: any;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\treqData = options.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\t// $防止遮蔽\n\t\t\tsuccess($data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse($data, 'success', xhr, url, reqData);\n\t\t\t\trs({\n\t\t\t\t\tdata: $data,\n\t\t\t\t\tnext() {\n\t\t\t\t\t\tisFn(complete) && complete($data, xhr, url, reqData);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\t// $防止遮蔽\n\t\t\terror(err, $data, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse($data, 'error', xhr, url, reqData);\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(complete) && complete(undefined, xhr, url, reqData);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\nexport interface APIzClientOptions {\n\tbeforeSend?(xhr: XMLHttpRequest): void | boolean,\n\tafterResponse?(resData: any, status: string, xhr: XMLHttpRequest, url: string, reqData: any): void,\n\tcomplete?(resData: any, xhr: XMLHttpRequest, url: string, reqData: any): void,\n\tretry?: number\n}\n\ninterface RequestOptions extends APIzClientOptions {\n\tid?: number;\n\turl: string;\n\ttype?: APIzClientType;\n\toptions?: AsyncOptions;\n\tmethod: HTTPMethodUpperCase;\n\tdata?: any;\n}\n\nexport type APIzClientType = keyof MIMEType;\n\nexport type APIzClientMeta = any;\n\nexport type APIzClientInstance = APIzClient<AsyncOptions, APIzClientType, APIzClientMeta, HTTPMethodLowerCase>;\n\nexport { AsyncOptions as APIzRequestOptions };\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts: APIzClientOptions = {}): APIzClientInstance {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur as HTTPMethodLowerCase] = ({ name, meta, url, options }: ClientRequestOptions<AsyncOptions, APIzClientType, APIzClientMeta>) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase,\n\t\t\t\toptions\n\t\t\t}), prev), {} as APIzClient<AsyncOptions, APIzClientType, APIzClientMeta, HTTPMethodLowerCase>),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur as HTTPMethodLowerCase] = ({ name, meta, url, body, options, type }: ClientRequestOptions<AsyncOptions, APIzClientType, APIzClientMeta>) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase,\n\t\t\t\tdata: body\n\t\t\t}), prev), {} as APIzClient<AsyncOptions, APIzClientType, APIzClientMeta, HTTPMethodLowerCase>)\n\t};\n}\n"],"names":["retryMap","isFn","f","reqId","Date","now","request","opts","url","method","type","data","beforeSend","afterResponse","complete","retry","options","id","reqData","contentType","Promise","rs","rj","ajax","success","$data","xhr","next","error","err","undefined","reduce","prev","cur","name","meta","toUpperCase","body"],"mappings":"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"}