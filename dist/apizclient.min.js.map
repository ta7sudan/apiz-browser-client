{"version":3,"file":"apizclient.min.js","sources":["apizclient.js"],"sourcesContent":["/* global DEBUG */\nimport { ajax } from 'tinyjx';\n\nconst retryMap = {}, isFn = f => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts) {\n\tlet { url, method, type, data, beforeSend, afterResponse, onError, retry = 0, options = {}, id = ++reqId } = opts;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\toptions.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\tsuccess(data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse(data, xhr, url, options.data);\n\t\t\t\trs(data);\n\t\t\t},\n\t\t\terror(err, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse(null, xhr, url, options.data);\n\t\t\t\t\t// 受限于Promise, 没办法知道最后一个Promise什么时候结束,\n\t\t\t\t\t// 只能通过传入一个next, 由用户自己决定要不要触发全局异常处理,\n\t\t\t\t\t// 但是这增加了使用者的心智负担, 如果不记得调用next, 则全局异常处理\n\t\t\t\t\t// 不会被调用, 理想情况应当是不记得自行处理异常则默认fallback到全局\n\t\t\t\t\t// 异常, 但是没办法做到, 只能以这样一种蹩脚的形式处理了, 有好过没有\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(onError) && onError(err, xhr, url, options.data);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\n/**\n * { beforeSend, afterResponse, onError, retry }\n */\nexport default function (opts = {}) {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, options }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\toptions\n\t\t\t}), prev), {}),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, body, options, type }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\tdata: body\n\t\t\t}), prev), {})\n\t};\n}\n"],"names":["request","opts","url","method","type","data","beforeSend","afterResponse","onError","retry","options","id","reqId","retryMap","contentType","Promise","rs","rj","ajax","success","xhr","isFn","error","err","next","reduce","prev","cur","name","meta","toUpperCase","body","f","Date","now"],"mappings":"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"}