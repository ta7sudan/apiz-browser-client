{"version":3,"file":"apizclient.min.js","sources":["apizclient.js"],"sourcesContent":["/* global DEBUG */\n// tslint:disable-next-line\nimport { MIMEType, ajax, AsyncOptions } from 'tinyjx';\n// tslint:disable-next-line\nimport { APIzClient, HTTPMethodLowerCase, ClientRequestOptions, HTTPMethodUpperCase } from \"apiz-ng\";\n\nconst retryMap: {\n\t[k: number]: number;\n\t// tslint:disable-next-line\n} = {}, isFn = (f: any): f is Function => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts: RequestOptions): Promise<any> {\n\t// tslint:disable-next-line\n\tlet { url, method, type, data, beforeSend, afterResponse, complete, retry = 0, options = {}, id = ++reqId } = opts, reqData: any;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\treqData = options.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\t// $防止遮蔽\n\t\t\tsuccess($data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse($data, 'success', xhr, url, reqData);\n\t\t\t\trs({\n\t\t\t\t\t$data,\n\t\t\t\t\tnext() {\n\t\t\t\t\t\tisFn(complete) && complete($data, xhr, url, reqData);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\t// $防止遮蔽\n\t\t\terror(err, $data, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse($data, 'error', xhr, url, reqData);\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(complete) && complete(undefined, xhr, url, reqData);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\nexport interface APIzClientOptions {\n\tbeforeSend?(xhr: XMLHttpRequest): void | boolean,\n\tafterResponse?(resData: any, status: string, xhr: XMLHttpRequest, url: string, reqData: any): void,\n\tcomplete?(resData: any, xhr: XMLHttpRequest, url: string, reqData: any): void,\n\tretry?: number\n}\n\ninterface RequestOptions extends APIzClientOptions {\n\tid?: number;\n\turl: string;\n\ttype?: APIzClientType;\n\toptions?: AsyncOptions;\n\tmethod: HTTPMethodUpperCase;\n\tdata?: any;\n}\n\nexport type APIzClientType = keyof MIMEType;\n\nexport type APIzClientMeta = any;\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts: APIzClientOptions = {}): APIzClient<APIzClientType, APIzClientMeta, AsyncOptions, HTTPMethodLowerCase> {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur as HTTPMethodLowerCase] = ({ name, meta, url, options }: ClientRequestOptions<APIzClientType, APIzClientMeta, AsyncOptions>) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase,\n\t\t\t\toptions\n\t\t\t}), prev), {} as APIzClient<APIzClientType, APIzClientMeta, AsyncOptions, HTTPMethodLowerCase>),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur as HTTPMethodLowerCase] = ({ name, meta, url, body, options, type }: ClientRequestOptions<APIzClientType, APIzClientMeta, AsyncOptions>) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase() as HTTPMethodUpperCase,\n\t\t\t\tdata: body\n\t\t\t}), prev), {} as APIzClient<APIzClientType, APIzClientMeta, AsyncOptions, HTTPMethodLowerCase>)\n\t};\n}\n"],"names":["request","opts","reqData","url","method","type","data","beforeSend","afterResponse","complete","retry","options","id","reqId","retryMap","contentType","Promise","rs","rj","ajax","success","$data","xhr","isFn","next","error","err","f","Date","now","reduce","prev","cur","name","meta","toUpperCase","body"],"mappings":"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"}