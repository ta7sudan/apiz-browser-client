{"version":3,"file":"apizclient.umd.js","sources":["../src/index.js"],"sourcesContent":["/* global DEBUG */\nimport { ajax } from 'tinyjx';\n\nconst retryMap = {}, isFn = f => typeof f === 'function';\nlet reqId = Date.now();\n\nfunction request(opts) {\n\tlet { url, method, type, data, beforeSend, afterResponse, complete, retry = 0, options = {}, id = ++reqId } = opts, reqData;\n\tretryMap[id] = -~retryMap[id];\n\topts.id = id;\n\tif (data) {\n\t\treqData = options.data = data;\n\t\toptions.contentType = type;\n\t}\n\toptions.url = url;\n\toptions.method = method;\n\treturn new Promise((rs, rj) => {\n\t\tajax({\n\t\t\tbeforeSend,\n\t\t\tsuccess(data, xhr) {\n\t\t\t\tdelete retryMap[id];\n\t\t\t\t// 算了, 这个异常还是让它直接crash掉吧, 和后面保持一致\n\t\t\t\tisFn(afterResponse) && afterResponse(data, 'success', xhr, url, reqData);\n\t\t\t\trs({\n\t\t\t\t\tdata,\n\t\t\t\t\tnext() {\n\t\t\t\t\t\tisFn(complete) && complete(data, xhr, url, reqData);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\terror(err, data, xhr) {\n\t\t\t\tif (retryMap[id] < retry + 1) {\n\t\t\t\t\trs(request(opts));\n\t\t\t\t} else {\n\t\t\t\t\tdelete retryMap[id];\n\t\t\t\t\tisFn(afterResponse) && afterResponse(data, 'error', xhr, url, reqData);\n\t\t\t\t\trj({\n\t\t\t\t\t\terr,\n\t\t\t\t\t\tnext() {\n\t\t\t\t\t\t\tisFn(complete) && complete(undefined, xhr, url, reqData);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t});\n\t});\n}\n\n/**\n * { beforeSend, afterResponse, retry }\n */\nexport default function (opts = {}) {\n\treturn {\n\t\t...['get', 'head'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, options }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\toptions\n\t\t\t}), prev), {}),\n\t\t...['post', 'put', 'patch', 'delete', 'options'].reduce((prev, cur) =>\n\t\t\t(prev[cur] = ({ name, meta, url, body, options, type }) => request({\n\t\t\t\t...opts,\n\t\t\t\turl,\n\t\t\t\ttype,\n\t\t\t\toptions,\n\t\t\t\tmethod: cur.toUpperCase(),\n\t\t\t\tdata: body\n\t\t\t}), prev), {})\n\t};\n}\n"],"names":["retryMap","isFn","f","reqId","Date","now","request","opts","url","method","type","data","beforeSend","afterResponse","complete","retry","options","id","reqData","contentType","Promise","rs","rj","ajax","success","xhr","next","error","err","undefined","reduce","prev","cur","name","meta","toUpperCase","body"],"mappings":"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"}